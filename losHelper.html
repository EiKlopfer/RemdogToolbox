<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Line of Sight Calculation with 127-Pixel Squares</title>
    <style>
        body {
            background-color: #1e1e1e; /* Dark background color */
            color: #ffffff; /* Light text color */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            margin: 0;
            padding: 20px;
            overflow: auto;
        }
        .controls {
            margin-bottom: 20px;
        }
        .container {
            position: relative;
            overflow: auto;
        }
        .grid {
            display: grid;
            gap: 0px;
        }
        .cell {
            width: 125px;
            height: 125px;
            background-color: #333333; /* Darker grid squares */
            border: 2px solid #555555; /* Slightly lighter border */
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .selected {
            background-color: #ff9800; /* Orange for selected squares */
        }
        .intersected {
            background-color: #e91e63; /* Pink for intersected squares */
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="controls">
        <label for="rows">Rows:</label>
        <input type="number" id="rows" value="7" min="1" max="20">
        <label for="columns">Columns:</label>
        <input type="number" id="columns" value="7" min="1" max="20">
        <button onclick="generateGrid()">Generate Grid</button>
    </div>

    <div class="container">
        <div class="grid" id="grid"></div>
        <canvas id="lineCanvas"></canvas>
    </div>

    <script>
        const gridElement = document.getElementById('grid');
        const canvas = document.getElementById('lineCanvas');
        const container = document.querySelector('.container');
        const ctx = canvas.getContext('2d');

        let grid = [];
        let startSquare = null;
        let targetSquare = null;
        const squareSize = 127; // Total size of square including border

        function resizeCanvas() {
            canvas.width = gridElement.scrollWidth;
            canvas.height = gridElement.scrollHeight;
        }

        window.addEventListener('resize', resizeCanvas);

        function generateGrid() {
            const rows = document.getElementById('rows').value;
            const columns = document.getElementById('columns').value;

            gridElement.style.gridTemplateColumns = `repeat(${columns}, ${squareSize}px)`;
            gridElement.style.gridTemplateRows = `repeat(${rows}, ${squareSize}px)`;

            gridElement.innerHTML = ''; // Clear existing grid
            grid = [];
            startSquare = null;
            targetSquare = null;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let row = 0; row < rows; row++) {
                grid[row] = [];
                for (let col = 0; col < columns; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.addEventListener('click', () => handleCellClick(row, col));
                    gridElement.appendChild(cell);
                    grid[row][col] = cell;
                }
            }

            resizeCanvas();
        }

        function handleCellClick(row, col) {
            if (!startSquare) {
                startSquare = { row, col };
                grid[row][col].classList.add('selected');
            } else if (!targetSquare) {
                targetSquare = { row, col };
                grid[row][col].classList.add('selected');
                drawLineOfSight();
            } else {
                resetSelection();
            }
        }

        function resetSelection() {
            startSquare = null;
            targetSquare = null;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            grid.flat().forEach(cell => {
                cell.classList.remove('selected', 'intersected');
            });
        }

        function wuLine(x0, y0, x1, y1) {
            const squares = [];
            
            const dx = Math.abs(x1 - x0);
            const dy = Math.abs(y1 - y0);
            const sx = x0 < x1 ? 1 : -1;
            const sy = y0 < y1 ? 1 : -1;

            let err = dx - dy;
            let e2;

            while (true) {
                const gridX = Math.floor(x0 / squareSize);
                const gridY = Math.floor(y0 / squareSize);
                
                if (!squares.some(square => square.x === gridX && square.y === gridY)) {
                    squares.push({ x: gridX, y: gridY });
                }

                if (x0 === x1 && y0 === y1) break;

                e2 = 2 * err;
                
                if (e2 > -dy) {
                    err -= dy;
                    x0 += sx;
                }
                if (e2 < dx) {
                    err += dx;
                    y0 += sy;
                }
            }

            return squares;
        }

        function drawLineOfSight() {
            const startX = startSquare.col * squareSize + Math.floor(squareSize / 2);
            const startY = startSquare.row * squareSize + Math.floor(squareSize / 2);
            const targetX = targetSquare.col * squareSize + Math.floor(squareSize / 2);
            const targetY = targetSquare.row * squareSize + Math.floor(squareSize / 2);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(targetX, targetY);
            ctx.strokeStyle = '#ffffff'; /* White line for high contrast */
            ctx.lineWidth = 2;
            ctx.stroke();

            const intersectedSquares = wuLine(startX, startY, targetX, targetY);
            highlightIntersectedSquares(intersectedSquares);
        }

        function highlightIntersectedSquares(intersectedSquares) {
            grid.flat().forEach(cell => {
                const cellX = parseInt(cell.dataset.col, 10);
                const cellY = parseInt(cell.dataset.row, 10);

                if (intersectedSquares.some(square => square.x === cellX && square.y === cellY)) {
                    cell.classList.add('intersected');
                }
            });
        }

        // Initial grid generation
        generateGrid();
    </script>
</body>
</html>
